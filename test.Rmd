---
title: "R_Project"
author: "Bodi and Jinni"
date: "2023-03-09"
output: html_document
---
```{r message=FALSE,warning=FALSE}


```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries
```{r message=FALSE,warning=FALSE}
library(tidyverse)
library(ggplot2)
library(gganimate)
library(dplyr)
```

```{r message=FALSE,warning=FALSE}




```

Load dataset
```{r message=FALSE,warning=FALSE}
inmi <- read_csv2("inmi.csv") # Migrants from outside of Spain
crime <- read_csv("crime.csv") # Crime rate 
crime <- crime[-c(20,21,22,23),]
uploy <- read.delim2("parados.csv") # Paro rate
uploy <- uploy[,c(2,4,5)]
renta <- read.delim2("renta.csv")
renta <- renta[,c(1,3,4)]
renta$Total <- as.numeric(renta$Total)*1000 # Easy change the decimal symbol. 

names(uploy)[1] <- "AR"
names(uploy)[2] <- "Year"
names(renta)[1] <- "AR"
names(renta)[2] <- "Year"
names(renta)[3] <- "Renta"
names(inmi)[1] <- "AR"
names(inmi)[2] <- "BirthCountry"
names(inmi)[3] <- "Year"
names(inmi)[4] <- "Migrants"
```


```{r message=FALSE,warning=FALSE}
# Filter out irrelevant/repeated info 
# Select index - merge all indexes - delete irrelevant observations
a <- which(inmi$AR == "Total Nacional")
b <- which(inmi$BirthCountry == "Total")
c <- which(inmi$BirthCountry == "UE27_2020 sin España")
d <- which(inmi$BirthCountry == "UE28 sin España")
e <- which(inmi$BirthCountry == "Europa menos UE28")
f <- which(inmi$BirthCountry == "Europa menos UE27_2020")
new <- c(a,b,c,d,e,f)
delidx <- unique(new)
inmi2 <- inmi[-c(delidx),]

inmi2$Migrants <- as.numeric(inmi2$Migrants)

# Removing years for which we don't have common data
remov <- c(which(inmi2$Year == 2008),which(inmi2$Year == 2009)) 
removidx <- unique(remov)
inmi2 <- inmi2[-c(removidx),]
inmi2$AR <- substring(inmi2$AR,4) #Remove numbers from AR names
uploy$Year <- substring(uploy$Year,1,4)
uploy$AR <- substring(uploy$AR,4)
renta$AR <- substring(renta$AR,4)
pivot <- pivot_longer(crime,2:13, names_to = "Year", values_to = "CrimeRate")
df <- merge(inmi2,pivot, by = c("AR","Year"))  

# Converting to annual Paro data. 
uploy_annual <- uploy %>%  group_by(AR,Year) %>%  summarise(Paro = mean(Total))

df_add_paro <- merge(df,uploy_annual, by = c("AR","Year")) 
df_final <- merge(df_add_paro, renta, by = c("AR","Year")) # Final Dataset so far

```

```{r message=FALSE,warning=FALSE}

df_group <- df_final %>% group_by(AR,Year) %>% summarise(Migrants = sum(Migrants,na.rm = TRUE), CrimeRate = mean(CrimeRate, na.rm = TRUE)) # Groupped by AR and year to have a clear view of data without giving importance to BirthCountry. 


```
